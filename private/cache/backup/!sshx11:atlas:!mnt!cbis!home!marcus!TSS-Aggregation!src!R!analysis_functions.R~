suppressMessages({
  library("sleuth")
  library(here)
  library("aggregation")
  library(tidyverse)
  library(cowplot)
  library(GeneOverlap)
  library(exact2x2)
})

agg_TSS_to_TF <- function(TSS_agg_table, tss2tf) {
    TSS_by_TF <-
        dplyr::left_join(TSS_agg_table, tss2tf) %>%
        mutate(qval=p.adjust(pval, method="BH")) %>%
        group_by(TF) %>%
        nest() %>%
        arrange(TF) %>%
        filter(!is.na(TF))

    cutoff <- 0.05

    aggregated_TSS_to_TF <- data.frame(TF=c(NA),pval=c(0.0))

    for (tf in TSS_by_TF$TF) {
        TSS <- TSS_by_TF %>%
            filter(TF == tf)
        TSS <- TSS$data[[1]]
        TSS_ids <- TSS$target_id
        no_TF <- TSS_agg_table %>% filter(!target_id %in% TSS_ids)
        ratio <- length(TSS_ids) / length(no_TF$qval)
        no_TF_no_DE <- sum(no_TF$qval > cutoff) * ratio
        no_TF_is_DE <- sum(no_TF$qval <= cutoff) * ratio
        TF_no_DE <- sum(TSS$qval > cutoff)
        TF_is_DE <- sum(TSS$qval <= cutoff)
        contingency_table <- matrix(c(no_TF_no_DE, no_TF_is_DE, TF_no_DE, TF_is_DE), nrow=2)
        fishers_test <- exact2x2(contingency_table, alternative="greater")
        new_entry <- c(tf, as.double(fishers_test$p.value))
        aggregated_TSS_to_TF <- rbind(aggregated_TSS_to_TF, new_entry)
        print(contingency_table)
    }

    aggregated_TSS_to_TF <- aggregated_TSS_to_TF %>%
        as_tibble %>%
        filter(!is.na(TF)) %>%
        mutate(pval=as.double(pval)) %>%
        mutate(padj=p.adjust(pval,method="bonferroni"),
           qval=p.adjust(pval,method="BH"))

    aggregated_TSS_to_TF
}

agg_gene_to_TF <- function(GENE_agg_table, tss2tf) {
    GENE_by_TF <-
        inner_join(GENE_agg_table,tx2tss,by="gene_id") %>%
        inner_join(tss2tf,by=c("TSS"="target_id")) %>%
        select(-TSS,-target_id.y,-target_id.x) %>%
        distinct() %>%
        mutate(qval=p.adjust(pval, method="BH")) %>%
        group_by(TF) %>%
        nest() %>%
        arrange(TF) %>%
        filter(!is.na(TF))

    print(GENE_by_TF)

    cutoff <- 0.05

    aggregated_GENE_to_TF <- data.frame(TF=c(NA),pval=c(0.0))

    for (tf in GENE_by_TF$TF) {
        TSS <- GENE_by_TF %>%
            filter(TF == tf)
        TSS <- TSS$data[[1]]
        TSS_ids <- TSS$gene_id
        no_TF <- GENE_agg_table %>% filter(!gene_id %in% TSS_ids)
        TF_no_DE <- sum(TSS$qval > cutoff)
        TF_is_DE <- sum(TSS$qval <= cutoff)
        no_TF_no_DE <- sum(no_TF$qval > cutoff)
        no_TF_is_DE <- sum(no_TF$qval <= cutoff)

        contingency_table <- matrix(c(no_TF_no_DE, no_TF_is_DE, TF_no_DE, TF_is_DE), nrow=2)
        fishers_test <- exact2x2(contingency_table, alternative="greater")
        new_entry <- c(tf, as.double(fishers_test$p.value))
        aggregated_GENE_to_TF <- rbind(aggregated_GENE_to_TF, new_entry)
    }

    aggregated_GENE_to_TF <- aggregated_GENE_to_TF %>%
        as_tibble %>%
        filter(!is.na(TF)) %>%
        mutate(pval=as.double(pval)) %>%
        mutate(padj=p.adjust(pval,method="bonferroni"),
           qval=p.adjust(pval,method="BH"))

    aggregated_GENE_to_TF
}
