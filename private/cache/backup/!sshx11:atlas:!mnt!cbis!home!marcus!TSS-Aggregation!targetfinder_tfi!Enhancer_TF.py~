import pandas as pd
import pybedtools
import os


def extract_enhancers(eep_fn):
    full_df = pd.read_csv(eep_fn)
    enhancer_df = full_df.loc[:,["enhancer_chrom",
                               "enhancer_start",
                               "enhancer_end",
                               "enhancer_name",
                               "promoter_name"]]

    return enhancer_df


def enhancer_tf_intersect(enhancer_fp, tfbs_fp):
    enhancer_obj = pybedtools.BedTool(enhancer_fp)
    tfbs_obj = pybedtools.BedTool(tfbs_fp)
    intersect_obj = enhancer_obj.intersect(tfbs_obj, wo=True)
    return intersect_obj


if __name__ == "__main__":
    extract_enhancers("data/eep_pairs.csv").to_csv("data/enhancers.bed.gz",
                                                 sep="\t",
                                                 index=False,
                                                 header=False)

    unibind_dir = "/mnt/raid0/home/marcus/TSS-Aggregation/data/reference_data/Unibind"
    output_dir = "/mnt/raid0/home/marcus/TSS-Aggregation/targetfinder_tfi/output"

    BEM_fp = os.path.join(unibind_dir, "BEM_TFBS_complete.bed.gz")
    DNAshaped_fp = os.path.join(unibind_dir, "DNAshaped_TFBS_complete.bed.gz")
    PWM_fp = os.path.join(unibind_dir, "PWM_TFBS_complete.bed.gz")
    TFFM_fp = os.path.join(unibind_dir, "TFFM_TFBS_complete.bed.gz")

    enhancer_tf_intersect("data/enhancers.bed.gz", BEM_fp).saveas(os.path.join(output_dir, BEM_enhancer_intersect.bed.gz))
